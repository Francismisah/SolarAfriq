<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="../assets/img/apple-icon.png"
    />
    <link rel="icon" type="image/png" href="assets/images/fav-icon/icon.png" />
    <title>SolarAfriq - OTP Verification</title>
    <link rel="stylesheet" href="style.css" type="text/css" media="all" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <link href="assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>
    <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      id="pagestyle"
      href="assets/css/soft-ui-dashboard.css?v=1.0.3"
      rel="stylesheet"
    />
  </head>
  <body class="g-sidenav-show bg-gray-100">
    <div class="container position-sticky z-index-sticky top-0"></div>
    <div class="row">
      <div class="col-12">
        <nav
          class="navbar navbar-expand-lg blur blur-rounded top-0 z-index-3 shadow position-absolute my-3 py-2 start-0 end-0 mx-4"
        >
          <div class="container-fluid">
            <div class="col-lg-2">
              <div class="header-logo">
                <a href="index.html"
                  ><img src="assets/images/header-logo.png" alt="logo"
                /></a>
              </div>
            </div>
            <a class="navbar-brand font-weight-bolder ms-lg-0 ms-3">
              OTP Verification
            </a>
            <button
              class="navbar-toggler shadow-none ms-2"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navigation"
              aria-controls="navigation"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon mt-2">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </span>
            </button>
            <ul class="navbar-nav d-lg-block d-none">
              <li class="nav-item">
                <a
                  href="https://burasolutions.com/"
                  class="btn btn-sm btn-round mb-0 me-1 bg-gradient-dark"
                  >Bura Solutions</a
                >
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </div>
    <section class="min-vh-100 mb-8">
      <div
        class="page-header align-items-start min-vh-50 pt-5 pb-11 m-3 border-radius-lg"
        style="background-image: url('assets/images/bradcumb-bg.jpg')"
      >
        <span class="mask bg-gradient-dark opacity-6"></span>
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-lg-5 text-center mx-auto">
              <h1 class="text-white mb-2 mt-5">Verify Your Account</h1>
              <p class="text-lead text-white">
                Please enter the OTP sent to your email to complete your
                registration.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="row mt-lg-n10 mt-md-n11 mt-n10">
          <div class="col-xl-4 col-lg-5 col-md-7 mx-auto">
            <div class="card z-index-0">
              <div class="card-header text-center pt-4">
                <h5>Enter OTP</h5>
              </div>
              <div class="card-body">
                <div id="otp-section">
                  <h4 class="text-center mb-3">Verify Your Account</h4>
                  <p class="text-center">
                    An OTP has been sent to your
                    <span id="otp-destination">email</span>. Please enter it
                    below to verify your account.
                  </p>
                  <form id="otp-form">
                    <div class="mb-3">
                      <label for="otp-input" class="form-label">OTP</label>
                      <input
                        type="text"
                        id="otp-input"
                        class="form-control"
                        placeholder="Enter OTP"
                        required
                        inputmode="numeric"
                        pattern="[0-9]*"
                        maxlength="6"
                      />
                    </div>
                    <div class="text-center">
                      <button type="submit" class="btn btn-success w-100 mb-2">
                        Verify OTP
                      </button>
                      <button
                        type="button"
                        id="resend-otp-btn"
                        class="btn btn-link text-info"
                      >
                        Resend OTP
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <footer class="footer py-5">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mb-4 mx-auto text-center">
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-5 me-3 mb-sm-0 mb-2"
            >
              Home
            </a>
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-5 me-3 mb-sm-0 mb-2"
            >
              Shop
            </a>
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-5 me-3 mb-sm-0 mb-2"
            >
              About Us
            </a>
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-5 me-3 mb-sm-0 mb-2"
            >
              Contact Us
            </a>
          </div>
          <div class="col-lg-8 mx-auto text-center mb-4 mt-2">
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-4 me-4"
            >
              <span class="text-lg fab fa-twitter"></span>
            </a>
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-4 me-4"
            >
              <span class="text-lg fab fa-linkedin-in"></span>
            </a>
            <a
              href="javascript:;"
              target="_blank"
              class="text-secondary me-xl-4 me-4"
            >
              <span class="text-lg fab fa-facebook-f"></span>
            </a>
          </div>
        </div>
        <div class="row">
          <div class="col-8 mx-auto text-center mt-1">
            <p class="mb-0 text-secondary">
              Copyright Â©
              <script>
                document.write(new Date().getFullYear());
              </script>
            </p>
          </div>
        </div>
      </div>
    </footer>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"
      integrity="sha512-nnzkI2u2Dy6HMnzMIkh7CPd1KX445z38XIu4jG1jGw7x5tSL3VBjE44dY="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/perfect-scrollbar/1.5.5/perfect-scrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scroll/16.1.3/smooth-scroll.min.js"></script>
    <script src="../solar-company/assets/js/soft-ui-dashboard.min.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"
      integrity="sha512-nnzkI2u2Dy6HMnzMIkh7CPd1KX445z38XIu4jG1jGw7x5tSL3VBjE44dY4ihMU1ijAQV930SPM12cCFrB18sVw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/perfect-scrollbar/1.5.5/perfect-scrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scroll/16.1.3/smooth-scroll.min.js"></script>
    <script src="../solar-company/assets/js/soft-ui-dashboard.min.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script>
      // Define your API URL globally or at least outside the DOMContentLoaded listener
      const graphql_ApiUrl = "https://solar-afriq.onrender.com/graphql"; // Use your actual deployed backend URL

      document.addEventListener("DOMContentLoaded", () => {
        const otpForm = document.getElementById("otp-form");
        const otpInput = document.getElementById("otp-input");
        const otpDestinationSpan = document.getElementById("otp-destination");
        const resendOtpBtn = document.getElementById("resend-otp-btn");

        let userEmailForOtp = localStorage.getItem("userEmailForOtp") || "";
        otpDestinationSpan.textContent = userEmailForOtp || "email"; // GraphQL Mutation for OTP Verification // IMPORTANT: Meticulously re-type all whitespace within the backticks to remove U+00A0

        const VERIFY_OTP_MUTATION = `
mutation VerifyEmail($email: String!, $otp: String!) {
  verifyEmail(email: $email, otp: $otp) {
    token
    user {
      id
      name
      email
    }
  }
}
`; // GraphQL Mutation for Resending OTP // IMPORTANT: Meticulously re-type all whitespace within the backticks to remove U+00A0

        const RESEND_OTP_MUTATION = `
mutation ResendOTP($email: String!) {
  resendOTP(email: $email) {
    message
  }
}
`; // Event Listener for OTP Verification Form Submission

        otpForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          const otp = otpInput.value.trim();

          if (!otp) {
            alert("Please enter the OTP.");
            return;
          }

          if (!userEmailForOtp) {
            alert(
              "No email found for OTP verification. Please try signing up again."
            );
            return;
          }

          const variables = {
            email: userEmailForOtp,
            otp: otp,
          };

          try {
            const response = await fetch(graphql_ApiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                query: VERIFY_OTP_MUTATION,
                variables: variables,
              }),
            });

            const result = await response.json();

            if (result.errors) {
              console.error("GraphQL OTP Verification Error:", result.errors);
              const errorMessage =
                result.errors.map((err) => err.message).join(", ") ||
                "OTP verification failed.";
              alert(`Verification failed: ${errorMessage}`);
            } else if (result.data && result.data.verifyEmail) {
              // <-- CHANGED HERE
              const { token, user } = result.data.verifyEmail; // <-- CHANGED HERE
              console.log("Account Verified! Token:", token, "User:", user);
              alert("Account successfully verified! Welcome " + user.fullName);

              localStorage.setItem("Token", token);
              localStorage.removeItem("userEmailForOtp"); // Clear email after successful verification
              window.location.href = "signIn.html";
            } else {
              console.error(
                "Unexpected API response for OTP verification:",
                result
              );
              alert(
                "An unexpected response was received from the server during OTP verification. Please try again."
              );
            }
          } catch (error) {
            console.error(
              "Network or parsing error during OTP verification:",
              error
            );
            alert(
              "An error occurred during OTP verification. Please check your internet connection and try again."
            );
          }
        }); // Event Listener for Resend OTP Button

        resendOtpBtn.addEventListener("click", async () => {
          if (!userEmailForOtp) {
            alert(
              "No email found to resend OTP. Please start the signup process again."
            );
            return;
          }

          resendOtpBtn.disabled = true;
          resendOtpBtn.textContent = "Sending...";

          try {
            const variables = {
              email: userEmailForOtp,
            };

            const response = await fetch(graphql_ApiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                query: RESEND_OTP_MUTATION,
                variables: variables,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.error(
                "HTTP Error during resend OTP:",
                response.status,
                errorText
              );
              alert(
                `Resend failed: Server responded with an error (${response.status}). Please try again later.`
              );
              return;
            }

            const result = await response.json();

            if (result.errors) {
              console.error("GraphQL Resend OTP Error:", result.errors);
              const errorMessage =
                result.errors.map((err) => err.message).join(", ") ||
                "Failed to resend OTP.";
              alert(`Resend failed: ${errorMessage}`);
            } else if (result.data && result.data.resendOTP) {
              console.log(
                "Resend OTP successful:",
                result.data.resendOTP.message
              );
              alert("A new OTP has been sent to " + userEmailForOtp + ".");
            } else {
              console.error("Unexpected API response for resend OTP:", result);
              alert(
                "An unexpected response was received when trying to resend OTP."
              );
            }
          } catch (error) {
            console.error("Network or parsing error during resend OTP:", error);
            alert(
              "An error occurred when trying to resend OTP. Check console for details."
            );
          } finally {
            setTimeout(() => {
              resendOtpBtn.disabled = false;
              resendOtpBtn.textContent = "Resend OTP";
            }, 5000);
          }
        });
      });
    </script>
  </body>
</html>
